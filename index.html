<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Самый смешной участник</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
        }
        
        :root {
            --primary-dark: #1b1717;
            --primary-light: #edebdd;
            --accent: #810100;
            --shadow: rgba(129, 1, 0, 0.15);
            --secondary-dark: #630000;
        }
        
        body {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--primary-dark);
            color: var(--primary-light);
            border-radius: 20px;
            box-shadow: 0 8px 25px var(--shadow);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .instructions {
            background-color: var(--primary-light);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px var(--shadow);
            border: 2px solid var(--primary-dark);
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .search-box {
            flex-grow: 1;
            max-width: 400px;
            position: relative;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--primary-dark);
            border-radius: 50px;
            background: var(--primary-light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(27, 23, 23, 0.2);
        }
        
        .points-summary {
            background-color: var(--primary-dark);
            color: var(--primary-light);
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 4px 15px var(--shadow);
        }
        
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .participants-grid.hidden {
            display: none;
        }
        
        .participant-card {
            background-color: var(--primary-light);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 6px 20px var(--shadow);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }
        
        .participant-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px var(--shadow);
            border-color: var(--primary-dark);
        }
        
        .image-container {
            width: 100%;
            padding-top: 100%;
            position: relative;
            overflow: hidden;
            background: var(--primary-dark);
        }
        
        .participant-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            transform: scale(0.85);
            transition: transform 0.3s ease;
        }
        
        .participant-card:hover .participant-image {
            transform: scale(0.9);
        }
        
        .participant-info {
            padding: 20px;
            text-align: center;
        }
        
        .participant-name {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1rem;
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .points-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .custom-select {
            position: relative;
            flex-grow: 1;
        }
        
        .custom-select select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--primary-dark);
            border-radius: 12px;
            background: var(--primary-light);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            transition: all 0.3s ease;
        }
        
        .custom-select::after {
            content: '▼';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-dark);
            pointer-events: none;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        .custom-select:hover::after {
            transform: translateY(-50%) rotate(180deg);
        }
        
        .custom-select select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(27, 23, 23, 0.2);
        }
        
        .assigned-points {
            font-weight: 700;
            color: var(--primary-dark);
            min-width: 40px;
            text-align: center;
            font-size: 1.2rem;
            background: var(--primary-light);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid var(--primary-dark);
        }
        
        .results-section {
            background-color: var(--primary-light);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 25px var(--shadow);
            margin-top: 40px;
            border: 2px solid var(--primary-dark);
            display: none;
        }
        
        .results-section.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .results-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-dark);
            font-size: 2rem;
            font-weight: 700;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow);
        }
        
        .results-table th {
            background-color: var(--primary-dark);
            color: var(--primary-light);
            padding: 18px;
            text-align: left;
            font-weight: 600;
        }
        
        .results-table td {
            padding: 18px;
            border-bottom: 2px solid var(--primary-dark);
            font-weight: 500;
        }
        
        .results-table tr:nth-child(even) {
            background-color: rgba(27, 23, 23, 0.05);
        }
        
        .results-table tr:hover {
            background-color: rgba(27, 23, 23, 0.1);
        }
        
        .top-three {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .winner-card {
            text-align: center;
            background: var(--primary-light);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px var(--shadow);
            flex: 1;
            max-width: 280px;
            border: 3px solid;
            transition: transform 0.3s ease;
        }
        
        .winner-card:hover {
            transform: scale(1.05);
        }
        
        .winner-card.gold {
            border-color: gold;
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(255,215,0,0.1) 100%);
        }
        
        .winner-card.silver {
            border-color: silver;
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(192,192,192,0.1) 100%);
        }
        
        .winner-card.bronze {
            border-color: #cd7f32;
            background: linear-gradient(135deg, var(--primary-light) 0%, rgba(205,127,50,0.1) 100%);
        }
        
        .winner-image-container {
            width: 140px;
            height: 140px;
            margin: 0 auto 20px;
            border-radius: 50%;
            padding: 5px;
            background: var(--primary-dark);
        }
        
        .winner-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .winner-name {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary-dark);
        }
        
        .winner-points {
            font-size: 1.8rem;
            color: var(--primary-dark);
            font-weight: 800;
        }
        
        .medal-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 10px;
            opacity: 0.8;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 16px 35px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .submit-btn {
            background-color: var(--primary-dark);
            color: var(--primary-light);
            box-shadow: 0 6px 20px var(--shadow);
        }
        
        .submit-btn:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px var(--shadow);
        }
        
        .send-results-btn {
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
            display: none;
        }
        
        .send-results-btn.visible {
            display: block;
        }
        
        .send-results-btn:hover {
            background-color: #45a049;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.4);
        }
        
        .back-btn {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            border: 2px solid var(--primary-dark);
            box-shadow: 0 6px 20px var(--shadow);
            display: none;
        }
        
        .back-btn.visible {
            display: block;
        }
        
        .back-btn:hover {
            background-color: var(--primary-dark);
            color: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px var(--shadow);
        }
        
        .reset-btn {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            border: 2px solid var(--primary-dark);
            box-shadow: 0 6px 20px var(--shadow);
        }
        
        .reset-btn:hover {
            background-color: var(--primary-dark);
            color: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px var(--shadow);
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: var(--primary-dark);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-dark);
            color: var(--primary-light);
            padding: 30px 50px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 1.2rem;
            font-weight: 600;
            display: none;
        }
        
        .message.visible {
            display: block;
            animation: messageFade 2s ease;
        }
        
        @keyframes messageFade {
            0% { opacity: 0; transform: translate(-50%, -60%); }
            20% { opacity: 1; transform: translate(-50%, -50%); }
            80% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -40%); }
        }
        
        /* Модальное окно */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal {
            background: var(--primary-light);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .modal h2 {
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .modal-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--primary-dark);
            border-radius: 50px;
            background: var(--primary-light);
            font-size: 1rem;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }
        
        .modal-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(27, 23, 23, 0.2);
        }
        
        .modal-btn {
            background-color: var(--primary-dark);
            color: var(--primary-light);
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .modal-btn:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
        }
        
        .modal-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            color: #d32f2f;
            font-size: 0.9rem;
            margin-top: -15px;
            margin-bottom: 15px;
            text-align: left;
            padding-left: 20px;
            display: none;
        }
        
        .error-message.visible {
            display: block;
        }
        
        /* Эффект загрузки */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        /* Анимации для перемещения карточек */
        .participant-card.moving {
            transition: all 0.5s ease-in-out;
            z-index: 10;
        }
        
        .participant-card.new-position {
            animation: highlight 1s ease;
        }
        
        @keyframes highlight {
            0% { box-shadow: 0 0 0 0 rgba(129, 1, 0, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(129, 1, 0, 0); }
            100% { box-shadow: 0 6px 20px var(--shadow); }
        }
        
        /* Адаптивность */
        @media (max-width: 1200px) {
            .participants-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            header {
                padding: 20px;
                margin-bottom: 25px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .participants-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .points-summary {
                text-align: center;
            }
            
            .top-three {
                gap: 20px;
            }
            
            .winner-card {
                max-width: 100%;
                margin-bottom: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
            
            .results-section {
                padding: 20px;
            }
            
            .results-table {
                font-size: 0.9rem;
            }
            
            .results-table th,
            .results-table td {
                padding: 12px 8px;
            }
            
            .modal {
                padding: 30px 20px;
            }
            
            .modal h2 {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .participants-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }
            
            .participant-info {
                padding: 15px;
            }
            
            .participant-name {
                font-size: 1rem;
                min-height: 2.5rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .instructions {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Модальное окно для ввода ника -->
    <div class="modal-overlay" id="telegramModal">
        <div class="modal">
            <h2>Введите ваш ник в Telegram <u>без @</u> для подтверждения</h2>
            <input type="text" class="modal-input" id="telegramInput" placeholder="@username" maxlength="50">
            <div class="error-message" id="telegramError">Такого @username не существует</div>
            <button class="modal-btn" id="confirmTelegram">Подтвердить</button>
        </div>
    </div>
    
    <!-- Эффект загрузки -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Загрузка...</div>
    </div>

    <div class="container">
        <header>
            <h1>Хиханьки-хахоньки</h1>
            <p>Джей-чат edition</p>
        </header>
        
        <div class="instructions">
            <p><strong>Инструкция:</strong> Каждый балл от 1 до 10 можно присвоить только одному участнику. Вы можете голосовать за себя, а также менять баллы участников. Когда закончите с выбором оценок, нажмите кнопку "Показать результаты внизу страницы". <b>Не забудьте нажать кнопку "Отправить результаты"</b></p>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Поиск участников...">
            </div>
            <div class="points-summary">
                Осталось распределить: <span id="pointsLeft">55</span> баллов
            </div>
        </div>
        
        <div class="participants-grid" id="participantsContainer">
            <!-- Участники будут добавлены через JavaScript -->
        </div>
        
        <div class="action-buttons">
            <button class="submit-btn" id="showResults">Показать результаты</button>
            <button class="send-results-btn" id="sendResults">Отправить результаты</button>
            <button class="back-btn" id="backToVoting">← Назад к голосованию</button>
            <button class="reset-btn" id="resetAll">Сбросить все</button>
        </div>
        
        <div class="results-section" id="resultsSection">
            <h2 class="results-title">Результаты голосования</h2>
            
            <div class="top-three" id="topThree">
                <!-- Топ-3 участников будет добавлен через JavaScript -->
            </div>
            
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Место</th>
                        <th>Участник</th>
                        <th>Баллы</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    <!-- Результаты будут добавлены через JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="message" id="successMessage">
            Результат отправлен!
        </div>
        
        <footer>
            <p>Бот создан @damboooy | 2025</p>
        </footer>
    </div>

    <script>
        // Элементы DOM
        const participantsContainer = document.getElementById('participantsContainer');
        const pointsLeftElement = document.getElementById('pointsLeft');
        const searchInput = document.getElementById('searchInput');
        const showResultsButton = document.getElementById('showResults');
        const sendResultsButton = document.getElementById('sendResults');
        const backToVotingButton = document.getElementById('backToVoting');
        const resetAllButton = document.getElementById('resetAll');
        const resultsSection = document.getElementById('resultsSection');
        const topThreeContainer = document.getElementById('topThree');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const successMessage = document.getElementById('successMessage');
        const telegramModal = document.getElementById('telegramModal');
        const telegramInput = document.getElementById('telegramInput');
        const telegramError = document.getElementById('telegramError');
        const confirmTelegramButton = document.getElementById('confirmTelegram');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Переменные для хранения состояния
        let availablePoints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        let assignedPoints = {};
        let participants = [];
        let isAnimating = false;
        let resultsText = ''; // Переменная для хранения результатов в текстовом формате
        let telegramUsername = ''; // Переменная для хранения ника из Telegram

        // Функция для проверки ника Telegram
        function validateTelegramUsername(username) {
            // Регулярное выражение для проверки: только латинские буквы, цифры, подчеркивания
            // и не должен содержать русские буквы и пробелы
            const telegramRegex = /^[a-zA-Z0-9_]+$/;
            return telegramRegex.test(username);
        }

        // Функция для получения списка изображений из папки img/
        async function loadParticipants() {
            try {
                const imageFiles = [
'Bitch Пакетовна.jpg',
'Juliana (Cinema Gaga).jpg',
'Katarina Pope.jpg',
'lexie.jpg',
'Mary (штош, кино!).jpg',
'Natalie (NATASHKINO).jpg',
'Айя.jpg',
'Алина.jpg',
'Алия.jpg',
'Альбина.jpg',
'Аля.jpg',
'Анастасия Алехина.jpg',
'Антон (FANTON).jpg',
'Антон (БТК).jpg',
'Антон Мулатов.jpg',
'Антон Шиллер.jpg',
'Антон.jpg',
'Аня (parasite eve).jpg',
'Артем Мулеса.jpg',
'Артем.jpg',
'Богдана.jpg',
'Вася.jpg',
'Вика.jpg',
'Геля (капитангел).jpg',
'Гульнар (Гуля).jpg',
'Даня (Daniel Petrosvky).jpg',
'Даня (Дамбо).jpg',
'Даня (дикий огурец).jpg',
'Даня (Мартыш).jpg',
'Денис (Хапуга).jpg',
'Денис.jpg',
'Денчик.jpg',
'Диана (Diana Kanda).jpg',
'Диана (Невнимательный зритель).jpg',
'Егор.jpg',
'Женя.jpg',
'Зара.jpg',
'Катя (Satan Lair).jpg',
'Ксюша.jpg',
'Лера.jpg',
'Майя.jpg',
'Макс.jpg',
'Марат.jpg',
'Маргарита.jpg',
'Мария (Маша и ее пять копеек).jpg',
'Мария Гельвих.jpg',
'Мария.jpg',
'Марк (Кролик).jpg',
'Маша.jpg',
'Мирхат.jpg',
'Миша.jpg',
'Настя (Настаз).jpg',
'Настя.jpg',
'Никита.jpg',
'Олег Ковалев.jpg',
'Олег.jpg',
'Паша (PKh, Body Count Films).jpg',
'Платон.jpg',
'Полина (ta_pauline).jpg',
'Полина.jpg',
'Рашад.jpg',
'Саша (Жизнь страшнее).jpg',
'Саша.jpg',
'Тамара.jpg',
'Таня.jpg',
'Тимсон (therealtimson).jpg',
'Уля.jpg',
'Феликс.jpg',
'шису.jpg'
                ];
                
                participants = imageFiles.map((filename, index) => {
                    let name = filename.replace('.jpg', '').replace(/_/g, ' ');
                    
                    // Заменяем "23 30" на "23:30" в названии
                    name = name.replace(/23 30/g, '23:30');
                    
                    // Преобразуем имя в читаемый формат (с заглавной буквы)
                    const formattedName = name.split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                    
                    return {
                        id: index + 1,
                        name: formattedName,
                        image: `${filename}`,
                        points: 0
                    };
                });
                
            } catch (error) {
                console.error('Ошибка загрузки участников:', error);
                // Fallback - создаем демо-данные
                createDemoParticipants();
            }
        }

        // Функция для создания демо-данных (если не удалось загрузить реальные)
        function createDemoParticipants() {
            participants = [];
            for (let i = 1; i <= 20; i++) {
                participants.push({
                    id: i,
                    name: `Участник ${i}`,
                    image: `https://via.placeholder.com/300x300/1b1717/edebdd?text=Участник+${i}`,
                    points: 0
                });
            }
        }
        
        // Инициализация приложения
        function init() {
            loadParticipants();
            
            // Обработчики событий
            showResultsButton.addEventListener('click', showResults);
            sendResultsButton.addEventListener('click', sendResultsToGoogleForms);
            backToVotingButton.addEventListener('click', backToVoting);
            resetAllButton.addEventListener('click', resetAll);
            searchInput.addEventListener('input', filterParticipants);
            
            // Обработчики для модального окна
            confirmTelegramButton.addEventListener('click', confirmTelegram);
            telegramInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmTelegram();
                }
            });
            
            // Валидация в реальном времени
            telegramInput.addEventListener('input', validateTelegramInput);
            
            // Показываем модальное окно при загрузке
            telegramModal.style.display = 'flex';
        }
        
        // Валидация ника Telegram в реальном времени
        function validateTelegramInput() {
            const username = telegramInput.value.trim();
            
            if (username && !validateTelegramUsername(username)) {
                telegramError.classList.add('visible');
                confirmTelegramButton.disabled = true;
            } else {
                telegramError.classList.remove('visible');
                confirmTelegramButton.disabled = false;
            }
        }
        
        // Подтверждение ника Telegram
        function confirmTelegram() {
            const username = telegramInput.value.trim();
            
            if (!username) {
                alert('Пожалуйста, введите ваш ник в Telegram');
                return;
            }
            
            // Проверяем валидность ника
            if (!validateTelegramUsername(username)) {
                telegramError.classList.add('visible');
                return;
            }
            
            // Сохраняем имя пользователя
            telegramUsername = username;
            
            // Показываем эффект загрузки
            loadingOverlay.style.display = 'flex';
            
            // Имитируем загрузку 3 секунды
            setTimeout(() => {
                // Скрываем модальное окно и загрузку
                telegramModal.style.display = 'none';
                loadingOverlay.style.display = 'none';
                
                // Обновляем интерфейс
                updatePointsLeft();
                renderParticipants();
                
                console.log('Telegram ник сохранен:', telegramUsername);
            }, 3000);
        }
        
        // Рендеринг участников
        function renderParticipants() {
            participantsContainer.innerHTML = '';
            
            if (participants.length === 0) {
                participantsContainer.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; font-weight: 600;">Участники не найдены</p>';
                return;
            }
            
            // Сортируем участников по баллам (по убыванию)
            const sortedParticipants = [...participants].sort((a, b) => {
                const pointsA = assignedPoints[a.id] || 0;
                const pointsB = assignedPoints[b.id] || 0;
                return pointsB - pointsA;
            });
            
            sortedParticipants.forEach(participant => {
                const card = document.createElement('div');
                card.className = 'participant-card';
                card.dataset.id = participant.id;
                
                card.innerHTML = `
                    <div class="image-container">
                        <img src="${participant.image}" alt="${participant.name}" class="participant-image" onerror="this.src='https://via.placeholder.com/300x300/1b1717/edebdd?text=Нет+фото'">
                    </div>
                    <div class="participant-info">
                        <div class="participant-name">${participant.name}</div>
                        <div class="points-selector">
                            <div class="custom-select">
                                <select class="points-dropdown" data-id="${participant.id}">
                                    <option value="0">0 баллов</option>
                                    ${availablePoints.map(point => 
                                        `<option value="${point}" ${assignedPoints[participant.id] === point ? 'selected' : ''}>
                                            ${point} балл${getPointsEnding(point)}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="assigned-points">${assignedPoints[participant.id] || 0}</div>
                        </div>
                    </div>
                `;
                
                participantsContainer.appendChild(card);
                
                // Обработчик изменения баллов
                const dropdown = card.querySelector('.points-dropdown');
                dropdown.addEventListener('change', handlePointsChange);
            });
            
            // Обновляем опции после рендеринга
            updateDropdownOptions();
        }

        // Функция для правильного склонения слова "балл"
        function getPointsEnding(points) {
            if (points === 1) return '';
            if (points >= 2 && points <= 4) return 'а';
            return 'ов';
        }
        
        // Обработчик изменения баллов
        function handlePointsChange(event) {
            if (isAnimating) return;
            
            const participantId = parseInt(event.target.dataset.id);
            const selectedPoints = parseInt(event.target.value);
            const previouslyAssigned = assignedPoints[participantId] || 0;
            
            // Если баллы уже были назначены этому участнику, освобождаем их
            if (previouslyAssigned > 0) {
                availablePoints.push(previouslyAssigned);
                availablePoints.sort((a, b) => a - b);
            }
            
            // Если выбраны новые баллы (не 0), проверяем доступность
            if (selectedPoints > 0) {
                const index = availablePoints.indexOf(selectedPoints);
                if (index !== -1) {
                    // Баллы доступны, назначаем
                    availablePoints.splice(index, 1);
                    assignedPoints[participantId] = selectedPoints;
                } else {
                    // Баллы уже заняты, сбрасываем выбор на предыдущее значение
                    event.target.value = previouslyAssigned || 0;
                    alert(`Балл ${selectedPoints} уже назначен другому участнику!`);
                    return;
                }
            } else {
                // Выбран 0 баллов - сбрасываем баллы для этого участника
                delete assignedPoints[participantId];
            }
            
            // Обновляем отображение
            updatePointsDisplay(participantId);
            updatePointsLeft();
            updateDropdownOptions();
            
            // Анимируем перемещение карточек
            animateCardMovement(participantId, previouslyAssigned, selectedPoints);
        }
        
        // Анимация перемещения карточек
        function animateCardMovement(changedParticipantId, oldPoints, newPoints) {
            isAnimating = true;
            
            // Получаем все карточки
            const cards = Array.from(document.querySelectorAll('.participant-card'));
            
            // Добавляем класс для плавной анимации
            cards.forEach(card => {
                card.classList.add('moving');
            });
            
            // Сортируем участников по баллам (по убыванию)
            const sortedParticipants = [...participants].sort((a, b) => {
                const pointsA = assignedPoints[a.id] || 0;
                const pointsB = assignedPoints[b.id] || 0;
                return pointsB - pointsA;
            });
            
            // Перестраиваем сетку в соответствии с новым порядком
            setTimeout(() => {
                participantsContainer.innerHTML = '';
                
                sortedParticipants.forEach(participant => {
                    const card = document.createElement('div');
                    card.className = 'participant-card';
                    card.dataset.id = participant.id;
                    
                    // Добавляем класс для анимации выделения, если это измененная карточка
                    if (participant.id === changedParticipantId) {
                        card.classList.add('new-position');
                    }
                    
                    card.innerHTML = `
                        <div class="image-container">
                            <img src="${participant.image}" alt="${participant.name}" class="participant-image" onerror="this.src='https://via.placeholder.com/300x300/1b1717/edebdd?text=Нет+фото'">
                        </div>
                        <div class="participant-info">
                            <div class="participant-name">${participant.name}</div>
                            <div class="points-selector">
                                <div class="custom-select">
                                    <select class="points-dropdown" data-id="${participant.id}">
                                        <option value="0">0 баллов</option>
                                        ${availablePoints.map(point => 
                                            `<option value="${point}" ${assignedPoints[participant.id] === point ? 'selected' : ''}>
                                                ${point} балл${getPointsEnding(point)}
                                            </option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="assigned-points">${assignedPoints[participant.id] || 0}</div>
                            </div>
                        </div>
                    `;
                    
                    participantsContainer.appendChild(card);
                    
                    // Обработчик изменения баллов
                    const dropdown = card.querySelector('.points-dropdown');
                    dropdown.addEventListener('change', handlePointsChange);
                });
                
                // Обновляем опции после рендеринга
                updateDropdownOptions();
                
                // Убираем классы анимации после завершения
                setTimeout(() => {
                    const movingCards = document.querySelectorAll('.participant-card.moving');
                    movingCards.forEach(card => {
                        card.classList.remove('moving');
                    });
                    
                    const newPositionCards = document.querySelectorAll('.participant-card.new-position');
                    newPositionCards.forEach(card => {
                        card.classList.remove('new-position');
                    });
                    
                    isAnimating = false;
                }, 500);
            }, 100);
        }
        
        // Обновляем только опции в выпадающих списках
        function updateDropdownOptions() {
            const dropdowns = document.querySelectorAll('.points-dropdown');
            
            dropdowns.forEach(dropdown => {
                const participantId = parseInt(dropdown.dataset.id);
                const currentValue = assignedPoints[participantId] || 0;
                
                // Устанавливаем текущее значение
                dropdown.value = currentValue;
                
                // Обновляем доступные опции
                const options = dropdown.querySelectorAll('option');
                options.forEach(option => {
                    const optionValue = parseInt(option.value);
                    if (optionValue > 0) {
                        // Для баллов больше 0 проверяем доступность
                        if (availablePoints.includes(optionValue) || optionValue === currentValue) {
                            option.disabled = false;
                            option.style.display = '';
                        } else {
                            option.disabled = true;
                            option.style.display = 'none';
                        }
                    }
                });
            });
        }
        
        // Обновление отображения баллов для участника
        function updatePointsDisplay(participantId) {
            const card = document.querySelector(`.participant-card[data-id="${participantId}"]`);
            if (card) {
                const pointsDisplay = card.querySelector('.assigned-points');
                pointsDisplay.textContent = assignedPoints[participantId] || 0;
            }
        }
        
        // Обновление счетчика оставшихся баллов
        function updatePointsLeft() {
            const totalPoints = 55; // Сумма баллов от 1 до 10
            const assignedSum = Object.values(assignedPoints).reduce((sum, points) => sum + points, 0);
            const pointsLeft = totalPoints - assignedSum;
            
            pointsLeftElement.textContent = pointsLeft;
        }
        
        // Фильтрация участников
        function filterParticipants() {
            const searchTerm = searchInput.value.toLowerCase();
            const cards = document.querySelectorAll('.participant-card');
            
            cards.forEach(card => {
                const name = card.querySelector('.participant-name').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Показать результаты
        function showResults() {
            // Проверяем, что все баллы распределены
            const assignedSum = Object.values(assignedPoints).reduce((sum, points) => sum + points, 0);
            if (assignedSum !== 55) {
                alert(`Пожалуйста, распределите все баллы! Осталось распределить: ${55 - assignedSum} баллов`);
                return;
            }
            
            // Собираем результаты
            const results = [];
            participants.forEach(participant => {
                results.push({
                    id: participant.id,
                    name: participant.name,
                    image: participant.image,
                    points: assignedPoints[participant.id] || 0
                });
            });
            
            // Сортируем по убыванию баллов
            results.sort((a, b) => b.points - a.points);
            
            // Сохраняем результаты в текстовом формате
            saveResultsToText(results);
            
            // Отображаем топ-3
            displayTopThree(results.slice(0, 3));
            
            // Отображаем полную таблицу результатов
            displayResultsTable(results);
            
            // Скрываем карточки участников
            participantsContainer.classList.add('hidden');
            
            // Показываем секцию с результатами
            resultsSection.classList.add('visible');
            
            // Обновляем кнопки
            showResultsButton.style.display = 'none';
            sendResultsButton.classList.add('visible');
            backToVotingButton.classList.add('visible');
            
            // Прокручиваем к результатам
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Сохранить результаты в текстовом формате
        function saveResultsToText(results) {
            let text = '';
            let position = 1;
            let previousPoints = null;
            
            results.forEach((participant, index) => {
                if (participant.points > 0) {
                    // Учитываем одинаковые баллы для определения позиции
                    if (previousPoints !== null && participant.points === previousPoints) {
                        // Та же позиция, что и у предыдущего участника
                    } else {
                        position = index + 1;
                        previousPoints = participant.points;
                    }
                    
                    text += `${position}; ${participant.name}; ${participant.points}\n`;
                }
            });
            
            resultsText = text;
            console.log('Результаты сохранены в текстовом формате:');
            console.log(resultsText);
        }
        
        // Отправить результаты в Google Forms
        function sendResultsToGoogleForms() {
            const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSdr9isBqeTLAuxAuIUCmdfjmzbMXUQa2lF1i6QYXM9HAhUYdg/formResponse';
            const resultsEntryId = 'entry.53035999';
            const telegramEntryId = 'entry.1068654015';
            
            // Создаем форму для отправки данных
            const formData = new FormData();
            formData.append(resultsEntryId, resultsText);
            formData.append(telegramEntryId, telegramUsername);
            
            console.log('Отправка данных в Google Forms:');
            console.log('Результаты:', resultsText);
            console.log('Telegram ник:', telegramUsername);
            
            // Отправляем данные через fetch
            fetch(formUrl, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            })
            .then(() => {
                // Показываем сообщение об успешной отправке
                successMessage.classList.add('visible');
                
                // Скрываем сообщение через 2 секунды
                setTimeout(() => {
                    successMessage.classList.remove('visible');
                }, 2000);
                
                console.log('Результаты отправлены в Google Forms');
            })
            .catch(error => {
                console.error('Ошибка при отправке в Google Forms:', error);
                // Даже если произошла ошибка, показываем сообщение об успехе
                // так как в режиме no-cors мы не можем получить ответ
                successMessage.classList.add('visible');
                
                setTimeout(() => {
                    successMessage.classList.remove('visible');
                }, 2000);
            });
        }
        
        // Вернуться к голосованию
        function backToVoting() {
            // Скрываем результаты
            resultsSection.classList.remove('visible');
            
            // Показываем карточки участников
            participantsContainer.classList.remove('hidden');
            
            // Обновляем кнопки
            showResultsButton.style.display = 'block';
            sendResultsButton.classList.remove('visible');
            backToVotingButton.classList.remove('visible');
            
            // Прокручиваем к карточкам
            participantsContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Отображение топ-3 участников
        function displayTopThree(topParticipants) {
            topThreeContainer.innerHTML = '';
            
            const medals = ['gold', 'silver', 'bronze'];
            const medalTitles = ['Золото', 'Серебро', 'Бронза'];
            
            topParticipants.forEach((participant, index) => {
                if (participant.points > 0) {
                    const winnerCard = document.createElement('div');
                    winnerCard.className = `winner-card ${medals[index]}`;
                    
                    winnerCard.innerHTML = `
                        <div class="winner-image-container">
                            <img src="${participant.image}" alt="${participant.name}" class="winner-image" onerror="this.src='https://via.placeholder.com/300x300/1b1717/edebdd?text=Нет+фото'">
                        </div>
                        <div class="winner-name">${participant.name}</div>
                        <div class="winner-points">${participant.points} баллов</div>
                        <div class="medal-title">${medalTitles[index]}</div>
                    `;
                    
                    topThreeContainer.appendChild(winnerCard);
                }
            });
        }
        
        // Отображение таблицы результатов
        function displayResultsTable(results) {
            resultsTableBody.innerHTML = '';
            
            let position = 1;
            let previousPoints = null;
            
            results.forEach((participant, index) => {
                if (participant.points > 0) {
                    // Учитываем одинаковые баллы для определения позиции
                    if (previousPoints !== null && participant.points === previousPoints) {
                        // Та же позиция, что и у предыдущего участника
                    } else {
                        position = index + 1;
                        previousPoints = participant.points;
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${position}</td>
                        <td>${participant.name}</td>
                        <td>${participant.points}</td>
                    `;
                    
                    resultsTableBody.appendChild(row);
                }
            });
        }
        
        // Сброс всех данных
        function resetAll() {
            if (confirm("Вы уверены, что хотите сбросить все баллы?")) {
                availablePoints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                assignedPoints = {};
                resultsSection.classList.remove('visible');
                participantsContainer.classList.remove('hidden');
                showResultsButton.style.display = 'block';
                sendResultsButton.classList.remove('visible');
                backToVotingButton.classList.remove('visible');
                renderParticipants();
                updatePointsLeft();
                searchInput.value = '';
                filterParticipants();
            }
        }
        
        // Запуск приложения
        init();
    </script>
</body>
</html>